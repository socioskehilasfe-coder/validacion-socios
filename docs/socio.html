<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Credencial de Socio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body{
    margin:0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    background: linear-gradient(180deg,#0b3a67,#0a2f52);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
  }

  .card{
    background:#fff;
    width:100%;
    max-width:420px;
    border-radius:26px;
    padding:26px;
    box-shadow:0 20px 40px rgba(0,0,0,.25);
    text-align:center;
  }

  .logo{
    max-width:140px;
    margin-bottom:14px;
  }

  h1{
    font-size:22px;
    margin:8px 0 18px;
    color:#0b3a67;
  }

  .dato{
    font-size:15px;
    margin:6px 0;
  }

  .estado{
    margin:18px 0;
    padding:14px;
    border-radius:14px;
    font-weight:700;
  }

  .activo{ background:#dcfce7; color:#166534; }
  .inactivo{ background:#fee2e2; color:#991b1b; }

  .fecha{
    font-size:13px;
    color:#555;
    margin-bottom:18px;
  }

  select{
    width:100%;
    padding:14px;
    border-radius:14px;
    border:1px solid #ccc;
    font-size:15px;
    margin-bottom:14px;
    max-height:180px;
  }

  button{
    width:100%;
    padding:16px;
    border-radius:16px;
    border:none;
    background:#0b3a67;
    color:#fff;
    font-size:16px;
    font-weight:700;
    cursor:pointer;
    transition:.25s;
  }

  button:disabled{
    opacity:.5;
    cursor:not-allowed;
  }

  button:hover:not(:disabled){
    background:#092f52;
  }

  #mensajeOK{
    display:none;
    margin-top:16px;
    padding:14px;
    border-radius:14px;
    background:#dcfce7;
    color:#166534;
    font-weight:600;
  }

  .comercio-option{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .comercio-option img{
    width:32px;
    height:32px;
    object-fit:contain;
  }
</style>
</head>

<body>

<div class="card">
  <img src="logo.png" class="logo">

  <h1>Credencial de Socio</h1>

  <div class="dato"><b>Nombre:</b> <span id="nombre"></span></div>
  <div class="dato"><b>Apellido:</b> <span id="apellido"></span></div>
  <div class="dato"><b>DNI:</b> <span id="dni"></span></div>

  <div id="estado" class="estado"></div>

  <div class="fecha" id="fechaIngreso"></div>

  <select id="comercioSelect">
    <option value="">Seleccionar comercio</option>
  </select>

  <button id="btnValidar" disabled>Validar beneficio</button>

  <div id="mensajeOK">✔️ El beneficio fue validado y registrado con éxito</div>
</div>

<script>
const SHEET_SOCIOS = "https://opensheet.elk.sh/132gab3uRyy7_DnkFoyCNbBnoxXDu6gbXiIDr5LTe4nA/SOCIOS";
const SHEET_COMERCIOS = "https://opensheet.elk.sh/132gab3uRyy7_DnkFoyCNbBnoxXDu6gbXiIDr5LTe4nA/COMERCIOS";
const ENDPOINT_REGISTRO = "https://script.google.com/macros/s/AKfycbwoOOwECfYTHWG319-VZhofCU1CeHEKkocTIPkc_2B3bISL8oiKxhM50ACWiJh0jHeW/exec";

const params = new URLSearchParams(window.location.search);
const socioID = params.get("id");

const btnValidar = document.getElementById("btnValidar");
const comercioSelect = document.getElementById("comercioSelect");

let socio = null;
let comercioSeleccionado = null;

// Fecha / hora
const ahora = new Date();
document.getElementById("fechaIngreso").innerText =
  "Ingresó el " + ahora.toLocaleDateString() + " – " + ahora.toLocaleTimeString();

// Cargar socio
fetch(SHEET_SOCIOS)
.then(r=>r.json())
.then(data=>{
  socio = data.find(s=>s.ID===socioID);
  if(!socio){ document.body.innerHTML="Socio no encontrado"; return; }

  nombre.innerText=socio.Nombre;
  apellido.innerText=socio.Apellido;
  dni.innerText=socio.DNI;

  if(socio.Estado==="ACTIVO"){
    estado.innerText="SOCIO ACTIVO";
    estado.className="estado activo";
  }else{
    estado.innerText="SOCIO INACTIVO";
    estado.className="estado inactivo";
  }
});

// Cargar comercios
fetch(SHEET_COMERCIOS)
.then(r=>r.json())
.then(data=>{
  data.forEach(c=>{
    const opt=document.createElement("option");
    opt.value=c.Comercio;
    opt.textContent=c.Comercio;
    opt.dataset.beneficio=c.Beneficio;
    comercioSelect.appendChild(opt);
  });
});

// Habilitar botón
comercioSelect.addEventListener("change",()=>{
  comercioSeleccionado=comercioSelect.value;
  if(comercioSeleccionado && socio && socio.Estado==="ACTIVO"){
    btnValidar.disabled=false;
  }else{
    btnValidar.disabled=true;
  }
});

// Validar beneficio
btnValidar.addEventListener("click",()=>{
  fetch(ENDPOINT_REGISTRO,{
    method:"POST",
    body:JSON.stringify({
      Fecha:ahora.toLocaleDateString(),
      Hora:ahora.toLocaleTimeString(),
      Comercio:comercioSeleccionado,
      Beneficio:comercioSelect.selectedOptions[0].dataset.beneficio,
      ID:socio.ID,
      Nombre:socio.Nombre,
      Apellido:socio.Apellido,
      DNI:socio.DNI
    })
  });

  document.getElementById("mensajeOK").style.display="block";
  btnValidar.disabled=true;
});
</script>

</body>
</html>
