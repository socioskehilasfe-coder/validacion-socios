<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Validación de Socio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Arial, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #0b3c6f, #092a4a);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      background: #ffffff;
      width: 100%;
      max-width: 380px;
      padding: 26px 22px;
      border-radius: 24px;
      box-shadow: 0 18px 36px rgba(0,0,0,0.28);
      text-align: center;
    }

    .logo-card {
      width: 78px;
      margin-bottom: 12px;
    }

    h1 {
      font-size: 20px;
      color: #0b3c6f;
      margin-bottom: 12px;
    }

    .dato {
      margin: 6px 0;
      font-size: 15px;
      color: #374151;
    }

    .estado {
      margin-top: 14px;
      padding: 10px;
      border-radius: 14px;
      font-weight: 600;
      font-size: 14px;
    }

    .activo {
      background: #dcfce7;
      color: #166534;
    }

    .inactivo {
      background: #fee2e2;
      color: #991b1b;
    }

    .fecha {
      margin-top: 8px;
      font-size: 13px;
      color: #6b7280;
    }

    select {
      width: 100%;
      margin-top: 16px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #cbd5e1;
      font-size: 14px;
    }

    .beneficio {
      margin-top: 12px;
      padding: 10px;
      border-radius: 12px;
      font-size: 14px;
      display: none;
    }

    .beneficio.ok {
      background: #e0f2fe;
      color: #075985;
      display: block;
    }

    .beneficio.error {
      background: #fee2e2;
      color: #991b1b;
      display: block;
    }

    .btn {
      display: block;
      margin-top: 16px;
      padding: 12px;
      background: transparent;
      color: #0b3c6f;
      text-decoration: none;
      border-radius: 14px;
      font-size: 15px;
      border: 1px solid #0b3c6f;
    }

    .btn.disabled {
      opacity: 0.4;
      pointer-events: none;
    }
  </style>
</head>

<body>

<div class="card" id="card">

  <img src="logo.png" class="logo-card" alt="Logo Comunidad">

  <h1>Credencial de Socio</h1>

  <div class="dato"><strong>Nombre:</strong> <span id="nombre"></span></div>
  <div class="dato"><strong>Apellido:</strong> <span id="apellido"></span></div>
  <div class="dato"><strong>DNI:</strong> <span id="dni"></span></div>

  <div id="estado" class="estado"></div>
  <div id="fechaHora" class="fecha"></div>

  <!-- COMERCIOS -->
  <select id="comercioSelect">
    <option value="">Seleccionar comercio</option>
  </select>

  <div id="beneficioBox" class="beneficio"></div>

  <!-- VALIDAR -->
  <a href="#" id="btnValidar" class="btn">Validar beneficio</a>

</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  const SOCIOS_URL =
    "https://opensheet.elk.sh/132gab3uRyy7_DnkFoyCNbBnoxXDu6gbXiIDr5LTe4nA/SOCIOS";

  const BENEFICIOS_URL =
    "https://opensheet.elk.sh/132gab3uRyy7_DnkFoyCNbBnoxXDu6gbXiIDr5LTe4nA/BENEFICIOS";

  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwoOOwECfYTHWG319-VZhofCU1CeHEKkocTIPkc_2B3bISL8oiKxhM50ACWiJh0jHeW/exec";

  /* FECHA Y HORA */
  const ahora = new Date();
  const fecha = ahora.toLocaleDateString("es-AR");
  const hora = ahora.toLocaleTimeString("es-AR", { hour: "2-digit", minute: "2-digit" });

  fechaHora.textContent = `Ingresó el ${fecha} – ${hora} hs`;

  let socio = null;
  let beneficios = [];

  /* CARGAR SOCIO */
  fetch(SOCIOS_URL)
    .then(res => res.json())
    .then(data => {
      socio = data.find(s => s.ID === id);
      if (!socio) {
        document.getElementById("card").innerHTML = "<h1>Socio no encontrado</h1>";
        return;
      }

      nombre.textContent = socio.Nombre;
      apellido.textContent = socio.Apellido;
      dni.textContent = socio.DNI;

      if (socio.Estado === "ACTIVO") {
        estado.textContent = "SOCIO ACTIVO";
        estado.classList.add("activo");
      } else {
        estado.textContent = "SOCIO INACTIVO";
        estado.classList.add("inactivo");
        document.getElementById("btnValidar").classList.add("disabled");
      }
    });

  /* CARGAR BENEFICIOS */
  fetch(BENEFICIOS_URL)
    .then(res => res.json())
    .then(data => {
      beneficios = data;
      data.forEach(b => {
        const opt = document.createElement("option");
        opt.value = b.Comercio;
        opt.textContent = b.Comercio;
        comercioSelect.appendChild(opt);
      });
    });

  /* MOSTRAR BENEFICIO */
  comercioSelect.addEventListener("change", () => {
    const seleccionado = beneficios.find(
      b => b.Comercio === comercioSelect.value
    );

    if (seleccionado) {
      beneficioBox.textContent = "Beneficio: " + seleccionado.Beneficio;
      beneficioBox.className = "beneficio ok";
    } else {
      beneficioBox.textContent = "Este comercio no tiene beneficio";
      beneficioBox.className = "beneficio error";
    }
  });

  /* VALIDAR Y REGISTRAR */
  document.getElementById("btnValidar").addEventListener("click", (e) => {
    e.preventDefault();

    if (!socio || socio.Estado !== "ACTIVO") return;

    const comercio = comercioSelect.value;
    const beneficio = beneficioBox.textContent;

    if (!comercio || !beneficioBox.classList.contains("ok")) {
      alert("Seleccioná un comercio válido");
      return;
    }

    fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        id: socio.ID,
        nombre: socio.Nombre,
        apellido: socio.Apellido,
        dni: socio.DNI,
        comercio: comercio,
        beneficio: beneficio.replace("Beneficio: ", ""),
        fecha: fecha,
        hora: hora
      })
    });

    alert("Beneficio validado y registrado correctamente");
  });
</script>

</body>
</html>
